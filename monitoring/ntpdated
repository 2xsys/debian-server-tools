#!/bin/bash
#
# Run ntpdate daily and on reboot to correct the system clock.
#
# VERSION       :0.6.0
# DATE          :2016-03-06
# AUTHOR        :Viktor Sz√©pe <viktor@szepe.net>
# LICENSE       :The MIT License (MIT)
# URL           :https://github.com/szepeviktor/debian-server-tools
# BASH-VERSION  :4.2+
# DEPENDS       :apt-get install ntpdate bind9-host
# LOCATION      :/usr/local/sbin/ntpdated
# CRON.D        :@reboot	root	/usr/local/sbin/ntpdated
# CRON.D        :@hourly	root	/usr/local/sbin/ntpdated

# Options can be set in /etc/default/ntpdate

# Work-around for pool.ntp.org DNS failures
Get_pool_ips() {
    local -i SERVER_INDEX="0"
    local -a SERVERS=( ${NTPSERVERS} 0.europe.pool.ntp.org )
    local A_RECORDS
    local -A IPS

    while [ "${#IPS[*]}" -lt 4 ] && [ -n "${SERVERS[$SERVER_INDEX]}" ]; do
        A_RECORDS="$(host -t A "${SERVERS[$SERVER_INDEX]}" 2>&1 | sed -ne 's;^\S\+ has \(IPv4 \)\?address \([.0-9]\+\)$;\2;p')"
        # Retry on DNS failure
        if [ -z "$A_RECORDS" ]; then
            sleep 3
            continue
        fi
        while read -r A; do
            # Prevent duplication by using array indices
            IPS[$A]="1"
        done <<< "$A_RECORDS"
        SERVER_INDEX+="1"
    done

    echo "${!IPS[*]}"
}

if [ -r /etc/default/ntpdate ]; then
    source /etc/default/ntpdate
fi

/usr/sbin/ntpdate -s ${NTPOPTIONS} $(Get_pool_ips)

exit 0
