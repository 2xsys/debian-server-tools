<IfModule mod_ssl.c>
<VirtualHost *:443>
    # site-specific data
    Define SITE_DOMAIN @@SITE_DOMAIN@@
    Define SITE_USER @@USER@@
    Define DOCUMENT_ROOT /home/${SITE_USER}/public_html/server
    Define WORDPRESS_ROOT ${DOCUMENT_ROOT}/site
    Define WORDPRESS_UPLOADS ${DOCUMENT_ROOT}/static/uploads

    ServerName ${SITE_DOMAIN}
    ServerAlias www.${SITE_DOMAIN}

    AssignUserID ${SITE_USER} ${SITE_USER}
    DocumentRoot ${DOCUMENT_ROOT}

    # terminate rewrite processing for php-fpm status
    #<Location /status>
    #    SetHandler application/x-httpd-php
    #    Require local
    #    RewriteRule ^/status$ - [END]
    #</Location>

    Alias /fcgi-bin/php5-fpm /fcgi-bin-php5-fpm-${SITE_USER}
    FastCgiExternalServer /fcgi-bin-php5-fpm-${SITE_USER} -socket /var/run/php5-fpm-${SITE_USER}.sock -idle-timeout 65 -pass-header Authorization

    <IfModule pagespeed_module>
        ModPagespeed off
        ModPagespeedFileCachePath /home/${SITE_USER}/public_html/pagespeed
        ModPagespeedRewriteDeadlinePerFlushMs 100
        #ModPagespeedMapRewriteDomain s.${SITE_DOMAIN} ${SITE_DOMAIN}

        #ModPagespeedEnableFilters rewrite_javascript
        ModPagespeedDisableFilters rewrite_images
        #ModPagespeedCssInlineMaxBytes 10
    </IfModule>

    RewriteEngine On

    # allow site traffic and .htaccess usage
    <Directory /home/${SITE_USER}/public_html>
        Options FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>
    # NO readme-s (site-wide)
    <LocationMatch "^.*(?i)readme\.txt$">
        Require all denied
    </LocationMatch>
    # NO root files
    <Directory ${WORDPRESS_ROOT}>
        <FilesMatch "^(licenc\.txt|olvasdel\.html|license\.txt|readme\.html|wp-config\.php|wp-config-sample\.php)$">
            Require all denied
        </FilesMatch>
    </Directory>
    # NO wp-includes PHP
    <Directory ${WORDPRESS_ROOT}/wp-includes>
        # deny first
        <FilesMatch \.php$>
            Require all denied
        </FilesMatch>
        <Files ms-files.php>
            Require all granted
        </Files>
    </Directory>
    <Directory ${WORDPRESS_ROOT}/wp-includes/js/tinymce>
        <Files wp-mce-help.php>
            Require all granted
        </Files>
        <Files wp-tinymce.php>
            Require all granted
        </Files>
    </Directory>
    # NO wp-admin PHP
    <Directory ${WORDPRESS_ROOT}/wp-admin>
        <Files install.php>
            Require all denied
        </Files>
    </Directory>
    <Directory ${WORDPRESS_ROOT}/wp-admin/includes>
        Require all denied
    </Directory>
    # NO uploads PHP
    <Directory ${WORDPRESS_UPLOADS}>
        <FilesMatch \.php$>
            Require all denied
        </FilesMatch>
    </Directory>

    # general rules
    <Directory ${DOCUMENT_ROOT}>
        # NO bot POST
        RewriteCond %{REQUEST_METHOD} =POST
        RewriteCond %{HTTP_USER_AGENT} ^$|bot|spider|crawl [NC]
        RewriteRule ^ - [F]

        # filename revisioning
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^(.+)\.(\d+\d+)\.(js|css|png|jpg|gif)$ $1.$3 [L]

        # missing JPEG-s
        #RewriteCond %{REQUEST_FILENAME} !-f
        #RewriteRule ^.*\.jpg$ /image.jpg [L]

        # canonical redirect
        RewriteCond %{HTTP_HOST} !=${SITE_DOMAIN}
        RewriteRule ^ http://${SITE_DOMAIN}%{REQUEST_URI} [R=permanent,L]

        # BEGIN WordPress
        RewriteRule ^/index\.php$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^ /index.php [L]
        # END WordPress
    </Directory>

    # don't index SEO files
    <LocationMatch "^.*(robots\.txt|sitemap\.xml)$">
        Header append X-Robots-Tag "noindex"
    </LocationMatch>

    # enable SSL
    SSLEngine On
    # self-signed certificates
    #SSLUseStapling Off
    # public key + "include intermediate CA certificates, sorted from leaf to root"
    # pub-key.pem + sub.class1.server.ca.pem
    SSLCertificateFile /etc/apache2/ssl/apache.pem
    # private key
    SSLCertificateKeyFile /etc/apache2/ssl/priv-key.key
    # "became obsolete with version 2.4.8"
    #SSLCertificateChainFile /etc/apache2/ssl.crt/server-ca.crt
    # root certificates
    SSLCACertificatePath /etc/ssl/certs/
    SSLCACertificateFile /etc/ssl/certs/ca-certificates.crt
    <FilesMatch "\.(cgi|shtml|phtml|php)$">
        SSLOptions +StdEnvVars
    </FilesMatch>
    <Directory /usr/lib/cgi-bin>
        SSLOptions +StdEnvVars
    </Directory>
    BrowserMatch "MSIE [2-6]" \
        nokeepalive ssl-unclean-shutdown \
        downgrade-1.0 force-response-1.0
    # MSIE 7 and newer should be able to use keepalive
    BrowserMatch "MSIE [17-9]" ssl-unclean-shutdown

    ErrorDocument 500 "System failure. Sorry! Please try again. webmaster@szepe.net"

    # log 404-s
    LogLevel info
    ErrorLog ${APACHE_LOG_DIR}/${SITE_USER}-error.log
    CustomLog ${APACHE_LOG_DIR}/${SITE_USER}-access.log combined
    ServerAdmin webmaster@szepe.net
</VirtualHost>
</IfModule>

<VirtualHost *:80>
    Define SITE_DOMAIN @@SITE_DOMAIN@@
    Define SITE_USER @@USER@@
    Define DOCUMENT_ROOT /home/${SITE_USER}/public_html/server

    ServerName ${SITE_DOMAIN}
    ServerAlias www.${SITE_DOMAIN}

    AssignUserID ${SITE_USER} ${SITE_USER}
    DocumentRoot ${DOCUMENT_ROOT}

    RewriteEngine on
    RewriteRule ^ https://www.atlantischild.hu%{REQUEST_URI} [R=permanent,L]

    # log 404-s
    LogLevel info
    ErrorLog ${APACHE_LOG_DIR}/${SITE_USER}-error.log
    CustomLog ${APACHE_LOG_DIR}/${SITE_USER}-access.log combined
    ServerAdmin webmaster@szepe.net
</VirtualHost>
