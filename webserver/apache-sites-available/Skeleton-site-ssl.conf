<IfModule mod_ssl.c>
<VirtualHost *:443>
    # Site-specific variables
    Define SITE_DOMAIN @@SITE_DOMAIN@@
    Define SITE_USER @@SITE_USER@@
    Define DOCUMENT_ROOT /home/${SITE_USER}/website/html
    Define WORDPRESS_ROOT_URL "/site/"
    Define WORDPRESS_UPLOADS_URL "/static/uploads/"

    ServerName ${SITE_DOMAIN}
    ServerAlias www.${SITE_DOMAIN}

    DocumentRoot "${DOCUMENT_ROOT}"

    ## Enable status for this php-fpm pool
    #<Location /statusphp>
    #    Require local
    #    <IfModule mod_proxy_fcgi.c>
    #       ProxyPass unix:///run/php5-fpm-${SITE_USER}.sock|fcgi://localhost${DOCUMENT_ROOT}
    #       #ProxyPass unix:///run/php/php7.0-fpm-${SITE_USER}.sock|fcgi://localhost${DOCUMENT_ROOT}
    #    </IfModule>
    #</Location>
    #RewriteEngine On
    #RewriteRule "^/statusphp$" - [END]

    ## Enable apache status - Consider enabling it in the webmail
    #<IfModule mod_status.c>
    #    <Location /server-status>
    #        SetHandler server-status
    #        Require local
    #    </Location>
    #    RewriteEngine On
    #    RewriteRule "^/server-status$" - [END]
    #</IfModule>

    <IfModule pagespeed_module>
        ModPagespeed off
        ModPagespeedStatistics off
        ModPagespeedFileCachePath /home/${SITE_USER}/website/pagespeed
        ModPagespeedRewriteDeadlinePerFlushMs 100
        #ModPagespeedMapRewriteDomain s.${SITE_DOMAIN} ${SITE_DOMAIN}

        #ModPagespeedEnableFilters rewrite_javascript
        ModPagespeedDisableFilters rewrite_images
        #ModPagespeedCssInlineMaxBytes 10
    </IfModule>

    <IfModule mod_proxy_fcgi.c>
        ProxyRequests Off
        ProxyTimeout 65
        # HTTP/Auth
        #SetEnvIfNoCase Authorization "(.+)" HTTP_AUTHORIZATION=$1
        <LocationMatch "^/.+\.php$">
        # /index.php/apps/files/
        #<LocationMatch "^/.+\.php(/.+)?$">
            # For aliases
            #ProxyPassMatch "unix:///run/php5-fpm-${SITE_USER}.sock|fcgi://localhost/ALIAS/PATH"
            ProxyPassMatch "unix:///run/php5-fpm-${SITE_USER}.sock|fcgi://localhost${DOCUMENT_ROOT}"
            # PHP 7.0
            #ProxyPassMatch "unix:///run/php/php7.0-fpm-${SITE_USER}.sock|fcgi://localhost${DOCUMENT_ROOT}"
        </LocationMatch>
    </IfModule>

    ## Static content
    #<LocationMatch ".+\.php">
    #    Require all denied
    #</LocationMatch>

    # Allow site traffic and .htaccess usage
    <Directory "/home/${SITE_USER}/website">
        Options FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    RewriteEngine On

    # Block direct access to plugins and themes
    # Exception: RewriteCond "%{REQUEST_URI}" "!=/static/plugins/entry-point.php"
    RewriteRule "/(mu-plugins|plugins|themes)/.*\.php" - [F]

    # Canonical redirect
    RewriteCond "%{HTTP_HOST}" "!=${SITE_DOMAIN}"
    RewriteRule "^" "%{REQUEST_SCHEME}://${SITE_DOMAIN}%{REQUEST_URI}" [R=permanent,L]
    #RewriteCond "%{HTTP_HOST}" "!=www.${SITE_DOMAIN}"
    #RewriteRule "^" "%{REQUEST_SCHEME}://www.${SITE_DOMAIN}%{REQUEST_URI}" [R=permanent,L]

    # Filename revisioning
    RewriteCond "${DOCUMENT_ROOT}%{REQUEST_FILENAME}" !-f
    RewriteRule "^(.+)\.\d\d+\.(js|css|png|jpg|gif)$" "$1.$2" [L]
    ## Filename revisioning - in <Directory>/.htaccess
    #RewriteCond "%{REQUEST_FILENAME}" !-f
    #RewriteRule "^(.+)\.\d\d+\.(js|css|png|jpg|gif)$" "$1.$2" [L]

    ## Missing images
    #RewriteCond "${DOCUMENT_ROOT}%{REQUEST_FILENAME}" !-f
    #RewriteRule "^.+\.(jpe?g|png|gif)$" "/default-image.jpg" [END]

    # Fixes
    <Directory "${DOCUMENT_ROOT}">
        
    </Directory>

    # Don't index files for robots
    <LocationMatch "^(robots\.txt|sitemap\.xml)$">
        Header append X-Robots-Tag "noindex"
    </LocationMatch>

    Include conf-available/wordpress.inc.conf

    # Enable SSL
    SSLEngine On
    # Off for self-signed certificates
    #SSLUseStapling Off
    # Public key + "include intermediate CA certificates, sorted from leaf to root"
    # Pub-key.pem + sub.classX.server.ca.pem
    SSLCertificateFile /etc/apache2/ssl/${SITE_DOMAIN}-public.pem
    # Private key
    SSLCertificateKeyFile /etc/apache2/ssl/${SITE_DOMAIN}-private.key
    # Diffie Hellman Ephemeral Parameters for OpenSSL 1.0.2+
    #     apt-get install -y haveged
    #     { nice openssl dhparam 1024; nice openssl dhparam 2048; nice openssl dhparam 4096; } \
    #     > /etc/apache2/ssl/${SITE_DOMAIN}-dhparams.pem
#    SSLOpenSSLConfCmd DHParameters /etc/apache2/ssl/${SITE_DOMAIN}-dhparams.pem
    # "became obsolete with version 2.4.8"
    #SSLCertificateChainFile /etc/apache2/ssl/server-ca.pem
    <FilesMatch "\.(cgi|shtml|phtml|php)$">
        SSLOptions +StdEnvVars
    </FilesMatch>
    <Directory /usr/lib/cgi-bin>
        SSLOptions +StdEnvVars
    </Directory>
    BrowserMatch "MSIE [2-6]" \
        nokeepalive ssl-unclean-shutdown \
        downgrade-1.0 force-response-1.0
    # MSIE 7 and newer should be able to use keepalive
    BrowserMatch "MSIE [17-9]" ssl-unclean-shutdown
    Header always set Strict-Transport-Security "max-age=16070400; includeSubDomains"

    ErrorDocument 500 "System failure. Sorry! Please try again. webmaster@szepe.net"

    # Log 404-s
    #LogLevel info ssl:notice pagespeed:notice
    LogLevel info ssl:notice
    ErrorLog ${APACHE_LOG_DIR}/${SITE_USER}-ssl-error.log
    ## CloudFlare, Incapsula
    #ErrorLog ${APACHE_LOG_DIR}/CF-${SITE_USER}-ssl-error.log
    CustomLog ${APACHE_LOG_DIR}/${SITE_USER}-ssl-access.log combined
</VirtualHost>
</IfModule>

<VirtualHost *:80>
    Define SITE_DOMAIN @@SITE_DOMAIN@@
    Define SITE_USER @@SITE_USER@@
    Define DOCUMENT_ROOT /home/${SITE_USER}/website/html

    ServerName ${SITE_DOMAIN}
    ServerAlias www.${SITE_DOMAIN}

    DocumentRoot "${DOCUMENT_ROOT}"

    Header always set Strict-Transport-Security "max-age=16070400; includeSubDomains"
    RewriteEngine on
    RewriteRule "^" "https://${SITE_DOMAIN}%{REQUEST_URI}" [R=permanent,L]

    # Log 404-s
    LogLevel info
    ErrorLog ${APACHE_LOG_DIR}/${SITE_USER}-error.log
    CustomLog ${APACHE_LOG_DIR}/${SITE_USER}-access.log combined
</VirtualHost>
